<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cat√°logo ‚Äì Luna Belle</title>
    <link rel="stylesheet" href="/static/css/catalogo.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
</head>

<body>

    <header class="navbar">
        <div class="logo">Luna Bella <span>Beauty</span> AI</div>

        <nav class="menu">
            <a href="/">Home</a>
            <a href="/catalogo" class="active">Cat√°logo</a>
            <a href="/cadastro">Cadastro</a>
            <a href="/carrinho">Carrinho</a>
            <a href="/logout" class="logout">Sair</a>
        </nav>
    </header>

    <section class="hero">
        <div class="hero-img">
            <img src="https://static.vecteezy.com/system/resources/previews/045/907/190/large_2x/cosmetics-arranged-on-pink-background-free-photo.jpeg" alt="Hero Makeup">
        </div>

        <div class="hero-content">
            <h1>Explore o Luxo da Beleza</h1>
            <p>Produtos premium selecionados pela intelig√™ncia artificial.</p>
            <a href="#produtos" class="btn-primary">Ver Cole√ß√£o</a>
        </div>
    </section>

    <section class="filtros">
        <h2>Filtrar Produtos</h2>

        <div class="filtros-grid">
            <select id="filtro-cat">
                <option value="">Todas as Categorias</option>
                <option value="base">Base</option>
                <option value="batom">Batom</option>
                <option value="corretivo">Corretivo</option>
                <option value="blush">Blush</option>
                <option value="p√≥">P√≥</option>
                <option value="mascara">M√°scara</option>
                <option value="iluminador">Iluminador</option>
                <option value="sombra">Sombra</option>
                <option value="gloss">Gloss</option>
                <option value="primer">Primer</option>
            </select>

            <select id="filtro-pele">
                <option value="">Todos os Tons de Pele</option>
                <option value="clara">Clara</option>
                <option value="media">M√©dia</option>
                <option value="escura">Escura</option>
                <option value="todos">Todos os Tons</option>
            </select>

            <select id="filtro-marca">
                <option value="">Todas as Marcas</option>
                <!-- As marcas ser√£o carregadas dinamicamente da API -->
            </select>

            <button id="btn-aplicar" class="btn-primary">Aplicar Filtros</button>
            <button id="btn-limpar" class="filtro-reset">Limpar</button>
        </div>
        
        <div class="filtro-info">
            <span id="filtro-contador" class="filtro-contador"></span>
            <span id="filtro-ativo" class="filtro-ativo-indicator"></span>
        </div>
    </section>

    <section id="produtos" class="catalogo">
        <h2>Cat√°logo Premium</h2>
        <p class="subtitle">Mais de 40 itens selecionados para voc√™</p>

        <div id="produtos-container" class="produtos-grid">
            <div class="carregando">
                <p>Carregando produtos...</p>
            </div>
        </div>
    </section>

    <footer>
        <p>¬© 2025 Luna Belle ‚Äî Beleza elevada ao m√°ximo.</p>
    </footer>

    <script>
        let produtos = [];
        let produtosFiltrados = [];
        let marcasUnicas = [];

        async function carregarProdutos() {
            try {
                console.log("üîÑ Carregando produtos da API...");
                const response = await fetch("/api/maquiagens");
                
                if (response.ok) {
                    produtos = await response.json();
                    console.log(`‚úÖ ${produtos.length} produtos carregados:`, produtos);
                    
                    // Extrai marcas √∫nicas dos produtos (com tratamento de valores nulos)
                    marcasUnicas = [...new Set(produtos.map(p => p.marca).filter(marca => marca))].sort();
                    console.log(`üìä Marcas encontradas:`, marcasUnicas);
                    
                    // Atualiza o filtro de marcas
                    atualizarFiltroMarcas();
                } else {
                    throw new Error(`API retornou status: ${response.status}`);
                }
            } catch (error) {
                console.error("‚ùå Erro ao carregar produtos:", error);
                mostrarErroCarregamento();
                produtos = [];
                marcasUnicas = [];
            }
            
            produtosFiltrados = [...produtos];
            exibirProdutos();
            atualizarContador();
        }

        function mostrarErroCarregamento() {
            const container = document.getElementById("produtos-container");
            container.innerHTML = `
                <div class="erro-carregamento">
                    <h3>‚ö†Ô∏è Erro ao carregar produtos</h3>
                    <p>N√£o foi poss√≠vel conectar com o banco de dados.</p>
                    <p>Verifique se o servidor Flask est√° rodando.</p>
                    <button class="btn-primary" onclick="carregarProdutos()">Tentar Novamente</button>
                </div>
            `;
        }

        function atualizarFiltroMarcas() {
            const filtroMarca = document.getElementById("filtro-marca");
            // Limpa op√ß√µes existentes (mantendo apenas a primeira)
            filtroMarca.innerHTML = '<option value="">Todas as Marcas</option>';
            
            // Adiciona as marcas do banco de dados
            marcasUnicas.forEach(marca => {
                const option = document.createElement("option");
                option.value = marca;
                option.textContent = marca;
                filtroMarca.appendChild(option);
            });
        }

        function exibirProdutos() {
            const container = document.getElementById("produtos-container");
            container.innerHTML = "";

            if (produtosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="sem-produtos">
                        <p>Nenhum produto encontrado com os filtros selecionados.</p>
                        <button class="btn-primary" onclick="limparFiltros()">Limpar Filtros</button>
                    </div>
                `;
                return;
            }

            produtosFiltrados.forEach(p => {
                // Garante que os dados existem para evitar erros
                const nome = p.nome || "Produto sem nome";
                const marca = p.marca || "Marca n√£o especificada";
                const categoria = p.categoria || "Sem categoria";
                const tomPele = p.tom_pele || "Todos os tons";
                const preco = p.preco ? parseFloat(p.preco).toFixed(2) : "0.00";
                const imagem = p.imagem || 'https://via.placeholder.com/300x300?text=Imagem+N√£o+Dispon√≠vel';
                const id = p.id || 0;
                const descricao = p.descricao || "Produto premium selecionado pela IA.";

                container.innerHTML += `
                    <div class="card fade-in">
                        <div class="card-img">
                            <img src="${imagem}" alt="${nome}" onerror="this.src='https://via.placeholder.com/300x300?text=Imagem+N√£o+Dispon√≠vel'">
                        </div>
                        <div class="card-body">
                            <h3>${nome}</h3>
                            <p class="marca">${marca}</p>
                            <p class="desc">${descricao}</p>
                            <div class="tags">
                                <span class="tag cat">${categoria}</span>
                                <span class="tag tono">${tomPele}</span>
                            </div>
                            <div class="price-row">
                                <p class="preco">R$ ${preco}</p>
                                <button class="btn-buy" onclick="adicionarAoCarrinho(${id})">Adicionar</button>
                            </div>
                            <button class="btn-rec" onclick="verRecomendados(${id})">
                                üí´ Ver semelhantes
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function filtrarProdutos() {
            const categoria = document.getElementById("filtro-cat").value;
            const tomPele = document.getElementById("filtro-pele").value;
            const marca = document.getElementById("filtro-marca").value;

            produtosFiltrados = produtos.filter(p => {
                return (!categoria || p.categoria === categoria) &&
                       (!tomPele || p.tom_pele === tomPele) &&
                       (!marca || p.marca === marca);
            });

            exibirProdutos();
            atualizarContador();
            atualizarIndicadorFiltroAtivo(categoria, tomPele, marca);
        }

        function limparFiltros() {
            document.getElementById("filtro-cat").value = "";
            document.getElementById("filtro-pele").value = "";
            document.getElementById("filtro-marca").value = "";
            
            produtosFiltrados = [...produtos];
            exibirProdutos();
            atualizarContador();
            atualizarIndicadorFiltroAtivo("", "", "");
        }

        function atualizarContador() {
            const contador = document.getElementById("filtro-contador");
            contador.textContent = `${produtosFiltrados.length} de ${produtos.length} produtos`;
        }

        function atualizarIndicadorFiltroAtivo(categoria, tomPele, marca) {
            const indicador = document.getElementById("filtro-ativo");
            const filtrosAtivos = [];
            
            if (categoria) filtrosAtivos.push(`Categoria: ${categoria}`);
            if (tomPele) filtrosAtivos.push(`Tom: ${tomPele}`);
            if (marca) filtrosAtivos.push(`Marca: ${marca}`);
            
            if (filtrosAtivos.length > 0) {
                indicador.textContent = `Filtros ativos: ${filtrosAtivos.join(', ')}`;
            } else {
                indicador.textContent = '';
            }
        }

        // Event Listeners
        document.getElementById("btn-aplicar").addEventListener("click", filtrarProdutos);
        document.getElementById("btn-limpar").addEventListener("click", limparFiltros);

        // Permitir filtro ao mudar sele√ß√£o nos selects
        document.querySelectorAll('.filtros select').forEach(select => {
            select.addEventListener('change', filtrarProdutos);
        });

        // Fun√ß√µes de recomenda√ß√£o
        async function verRecomendados(id) {
            try {
                const res = await fetch(`/api/recomendar/${id}`);
                const recs = await res.json();

                // Remove recomenda√ß√µes anteriores se existirem
                const existingRecs = document.getElementById('recomendacoes-section');
                if (existingRecs) {
                    existingRecs.remove();
                }

                if (recs.length === 0) {
                    mostrarRecomendacoesVazias();
                    return;
                }

                let cardsHTML = '';

                recs.forEach((r, index) => {
                    const recNome = r.nome || "Produto sem nome";
                    const recMarca = r.marca || "Marca n√£o especificada";
                    const recCategoria = r.categoria || "Sem categoria";
                    const recPreco = r.preco ? parseFloat(r.preco).toFixed(2) : "0.00";
                    const recImagem = r.imagem || 'https://via.placeholder.com/300x300?text=Imagem+N√£o+Dispon√≠vel';
                    const recId = r.id || 0;
                    const similaridade = r.similaridade ? (r.similaridade * 100).toFixed(0) : '85';

                    cardsHTML += `
                        <div class="recomendacao-card" style="animation-delay: ${index * 0.1}s">
                            <span class="similaridade-badge">${similaridade}% match</span>
                            <img src="${recImagem}" alt="${recNome}" class="recomendacao-img" onerror="this.src='https://via.placeholder.com/300x300?text=Imagem+N√£o+Dispon√≠vel'">
                            <h3 class="recomendacao-nome">${recNome}</h3>
                            <p class="recomendacao-marca">${recMarca}</p>
                            <span class="recomendacao-categoria">${recCategoria}</span>
                            <p class="recomendacao-preco">R$ ${recPreco}</p>
                            <div class="recomendacao-actions">
                                <button class="btn-add-cart" onclick="adicionarAoCarrinho(${recId})">
                                    üõí Adicionar
                                </button>
                                <button class="btn-favorite" onclick="favoritar(${recId})">
                                    ‚ù§Ô∏è
                                </button>
                            </div>
                        </div>
                    `;
                });

                const recomendacoesHTML = `
                    <section id="recomendacoes-section" class="recomendacoes-section">
                        <div class="recomendacoes-header">
                            <h2 class="recomendacoes-title">
                                ‚ú® Recomendados para voc√™
                            </h2>
                            <button class="close-recomendacoes" onclick="fecharRecomendacoes()">
                                √ó
                            </button>
                        </div>
                        <p style="color: #666; margin-bottom: 1.5rem;">
                            Baseado em suas prefer√™ncias e produtos similares
                        </p>
                        <div class="recomendacoes-grid">
                            ${cardsHTML}
                        </div>
                    </section>
                `;

                // Insere ap√≥s a se√ß√£o de cat√°logo
                const catalogoSection = document.getElementById('produtos');
                catalogoSection.insertAdjacentHTML('afterend', recomendacoesHTML);

                // Scroll suave para as recomenda√ß√µes
                document.getElementById('recomendacoes-section').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            } catch (error) {
                console.error("Erro ao carregar recomenda√ß√µes:", error);
                mostrarRecomendacoesVazias();
            }
        }

        function fecharRecomendacoes() {
            const recomendacoesSection = document.getElementById('recomendacoes-section');
            if (recomendacoesSection) {
                recomendacoesSection.remove();
            }
        }

        function mostrarRecomendacoesVazias() {
            const emptyHTML = `
                <section id="recomendacoes-section" class="recomendacoes-section">
                    <div class="empty-recomendacoes">
                        <div>üîç</div>
                        <h3>Nenhuma recomenda√ß√£o encontrada</h3>
                        <p>Tente outro produto para ver recomenda√ß√µes similares</p>
                    </div>
                </section>
            `;
            
            const catalogoSection = document.getElementById('produtos');
            catalogoSection.insertAdjacentHTML('afterend', emptyHTML);
        }

        // Fun√ß√µes auxiliares
        function adicionarAoCarrinho(id) {
            alert(`Produto ${id} adicionado ao carrinho!`);
            // Implementar l√≥gica do carrinho
        }

        function favoritar(id) {
            alert(`Produto ${id} favoritado!`);
            // Implementar l√≥gica de favoritos
        }

        // Inicializa√ß√£o
        window.onload = carregarProdutos;
    </script>

</body>
</html>